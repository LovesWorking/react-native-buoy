#!/usr/bin/env node
/**
 * Clipboard Detection Script
 *
 * This postinstall script detects which clipboard library is installed
 * and generates the appropriate implementation file.
 *
 * This approach provides TRUE zero-config because:
 * 1. No metro.config.js changes needed
 * 2. Detection happens at install time (not bundle time)
 * 3. Metro sees static imports only
 * 4. Works with any Metro version
 */

const fs = require("fs");
const path = require("path");

const OUTPUT_FILE = path.join(__dirname, "..", "src", "clipboard", "clipboard-impl.ts");

function moduleExists(name) {
  try {
    require.resolve(name);
    return true;
  } catch (e) {
    return false;
  }
}

let content;
let detectedModule;

if (moduleExists("expo-clipboard")) {
  detectedModule = "expo-clipboard";
  content = `/**
 * Auto-generated clipboard implementation
 * Detected: expo-clipboard
 * Generated at: ${new Date().toISOString()}
 *
 * DO NOT EDIT - This file is generated by scripts/detect-clipboard.js
 */

import { setStringAsync } from "expo-clipboard";

export type ClipboardFunction = (text: string) => Promise<boolean>;

export const clipboardType: "expo" | "react-native" | null = "expo";

export const isClipboardAvailable = (): boolean => true;

export const clipboardFunction: ClipboardFunction = async (text: string): Promise<boolean> => {
  try {
    await setStringAsync(text);
    return true;
  } catch (error) {
    console.error("[RnBetterDevTools] Clipboard copy failed:", error);
    return false;
  }
};
`;
} else if (moduleExists("@react-native-clipboard/clipboard")) {
  detectedModule = "@react-native-clipboard/clipboard";
  content = `/**
 * Auto-generated clipboard implementation
 * Detected: @react-native-clipboard/clipboard
 * Generated at: ${new Date().toISOString()}
 *
 * DO NOT EDIT - This file is generated by scripts/detect-clipboard.js
 */

import Clipboard from "@react-native-clipboard/clipboard";

export type ClipboardFunction = (text: string) => Promise<boolean>;

export const clipboardType: "expo" | "react-native" | null = "react-native";

export const isClipboardAvailable = (): boolean => true;

export const clipboardFunction: ClipboardFunction = async (text: string): Promise<boolean> => {
  try {
    Clipboard.setString(text);
    return true;
  } catch (error) {
    console.error("[RnBetterDevTools] Clipboard copy failed:", error);
    return false;
  }
};
`;
} else {
  detectedModule = null;
  content = `/**
 * Auto-generated clipboard implementation
 * Detected: none
 * Generated at: ${new Date().toISOString()}
 *
 * DO NOT EDIT - This file is generated by scripts/detect-clipboard.js
 *
 * No clipboard library found. Install one of:
 * - expo-clipboard (for Expo projects)
 * - @react-native-clipboard/clipboard (for RN CLI projects)
 */

export type ClipboardFunction = (text: string) => Promise<boolean>;

export const clipboardType: "expo" | "react-native" | null = null;

export const isClipboardAvailable = (): boolean => false;

export const clipboardFunction: ClipboardFunction = async (text: string): Promise<boolean> => {
  console.error(
    "[RnBetterDevTools] Copy failed: No clipboard library found.\\n" +
      \`Attempted to copy: \${text.substring(0, 50)}\${text.length > 50 ? "..." : ""}\\n\` +
      "Install expo-clipboard or @react-native-clipboard/clipboard, or provide a custom onCopy function."
  );
  return false;
};
`;
}

// Ensure directory exists
const dir = path.dirname(OUTPUT_FILE);
if (!fs.existsSync(dir)) {
  fs.mkdirSync(dir, { recursive: true });
}

fs.writeFileSync(OUTPUT_FILE, content);

console.log(
  `[@react-buoy/shared-ui] Clipboard implementation configured: ${detectedModule || "none"}`
);
